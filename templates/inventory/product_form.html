{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Add Product</h3>
    <a href="/products/" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Back</a>
</div>

<div class="card shadow-sm border-0" style="max-width: 600px;">
    <div class="card-body">
        <form id="product-form">
            <div class="mb-3">
                <label for="name" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="name" required>
            </div>
            <div class="mb-3">
                <label for="sku" class="form-label">SKU / Code</label>
                <input type="text" class="form-control" id="sku" required>
            </div>
            <div class="mb-3">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category">
                    <option value="">Select Category</option>
                    <!-- Populated by JS -->
                </select>
            </div>
            <div class="mb-3">
                <label for="uom" class="form-label">Unit of Measure</label>
                <input type="text" class="form-control" id="uom" placeholder="e.g. kg, pcs" required>
            </div>
            <div class="mb-3">
                <label for="min_stock" class="form-label">Minimum Stock Level</label>
                <input type="number" class="form-control" id="min_stock" value="0">
            </div>
            <button type="submit" class="btn btn-primary w-100">Save Product</button>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetchCategories();

        document.getElementById('product-form').addEventListener('submit', function (e) {
            e.preventDefault();
            createProduct();
        });
    });

    function fetchCategories() {
        fetch('/api/inventory/categories/')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('category');
                const results = data.results || data;
                results.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            });
    }

    function createProduct() {
        const data = {
            name: document.getElementById('name').value,
            sku: document.getElementById('sku').value,
            category: document.getElementById('category').value || null,
            uom: document.getElementById('uom').value,
            min_stock_level: document.getElementById('min_stock').value
        };

        fetch('/api/inventory/products/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/products/';
                } else {
                    alert('Error creating product');
                }
            });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}